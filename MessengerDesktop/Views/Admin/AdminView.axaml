<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MessengerDesktop.ViewModels"
             xmlns:shared="using:MessengerShared.DTO"
             xmlns:conv="using:MessengerDesktop.Converters"
             x:Class="MessengerDesktop.Views.AdminView"
             x:DataType="vm:AdminViewModel"
             x:Name="Root"
             Background="{DynamicResource PrimaryBG}"
			 Design.Width="1280" Design.Height="720">

	<UserControl.Resources>
		<DataTemplate x:Key="DepartmentTemplate" DataType="vm:HierarchicalDepartmentViewModel">
			<StackPanel Margin="0,0,0,4">
				<Border Background="{DynamicResource ThirdBG}"
                        Classes="Hoverable"
                        CornerRadius="8"
                        Margin="{Binding Level, Converter={conv:Converter Name=LevelToMargin}}">
					<Grid>
						<Border Height="2" Width="20"
                                Background="{DynamicResource HierarchyLineBrush}"
                                VerticalAlignment="Center" HorizontalAlignment="Left"
                                Margin="-20,0,0,0"
                                IsVisible="{Binding Level, Converter={conv:Converter Name=LevelToVisibility}}"/>

						<Border Padding="12">
							<Grid ColumnDefinitions="Auto,*,Auto">
								<Button Grid.Column="0"
                                        Command="{Binding ToggleExpandCommand}"
                                        IsVisible="{Binding HasChildren}"
                                        Classes="IconButton Subtle Small"
                                        Margin="0,0,12,0">
									<PathIcon Data="{StaticResource chevron_down}" Width="12" Height="12"
                                              Foreground="{DynamicResource TextSecondary}">
										<PathIcon.RenderTransform>
											<RotateTransform Angle="{Binding IsExpanded, Converter={conv:Converter Name=BooleanToRotateTransform}}"/>
										</PathIcon.RenderTransform>
									</PathIcon>
								</Button>

								<Border Grid.Column="0" Width="28" Height="28" Margin="0,0,12,0"
                                        IsVisible="{Binding !HasChildren}"/>

								<StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
									<Border Background="{DynamicResource CardBgBrush}" Width="40" Height="40" CornerRadius="10">
										<PathIcon Data="{StaticResource organization_regular}" Width="18" Height="18"
                                                  Foreground="{DynamicResource TextSecondary}"/>
									</Border>
									<TextBlock Text="{Binding Name}" FontSize="14" FontWeight="SemiBold"/>
								</StackPanel>

								<StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4">
									<Button Classes="IconButton Small"
                                            Command="{Binding DataContext.OpenEditDepartmentCommand, ElementName=Root}"
                                            CommandParameter="{Binding Department}"
                                            ToolTip.Tip="Редактировать отдел">
										<PathIcon Data="{StaticResource edit_regular}" Width="14" Height="14"
                                                  Foreground="{DynamicResource Icon}"/>
									</Button>
								</StackPanel>
							</Grid>
						</Border>
					</Grid>
				</Border>

				<Grid IsVisible="{Binding IsExpanded}" Margin="28,0,0,0">
					<Border Width="2" Background="{DynamicResource HierarchyLineBrush}"
                            HorizontalAlignment="Left" VerticalAlignment="Stretch"
                            Margin="8,0,0,12" IsVisible="{Binding HasChildren}"/>
					<ItemsControl ItemsSource="{Binding Children}" Margin="16,4,0,0"
                                  ItemTemplate="{StaticResource DepartmentTemplate}">
						<ItemsControl.ItemsPanel>
							<ItemsPanelTemplate>
								<StackPanel Spacing="4"/>
							</ItemsPanelTemplate>
						</ItemsControl.ItemsPanel>
					</ItemsControl>
				</Grid>
			</StackPanel>
		</DataTemplate>
	</UserControl.Resources>

	<Border Classes="PageContainer">
		<Grid ColumnDefinitions="260,*">

			<!-- Боковая панель -->
			<Border Grid.Column="0" Background="{DynamicResource SecondaryBG}"
                    BorderThickness="0,0,1,0" BorderBrush="{DynamicResource BorderDefault}">
				<DockPanel>
					<Border DockPanel.Dock="Top" Padding="20,24,20,16">
						<StackPanel Spacing="4">
							<TextBlock Text="Администрирование" FontSize="20" FontWeight="Bold"/>
							<TextBlock Text="Управление системой" FontSize="12"
                                       Foreground="{DynamicResource TextSecondary}"/>
						</StackPanel>
					</Border>

					<Border DockPanel.Dock="Top" Height="1"
                            Background="{DynamicResource BorderDefault}" Margin="16,0"/>

					<ScrollViewer DockPanel.Dock="Top" Margin="12,16">
						<StackPanel Spacing="4">
							<TextBlock Text="РАЗДЕЛЫ" Classes="CategoryHeader"/>
							<ListBox SelectedIndex="{Binding SelectedTabIndex}" Classes="NavMenu">
								<ListBoxItem>
									<StackPanel Orientation="Horizontal" Spacing="12">
										<PathIcon Data="{StaticResource person_regular}" Width="18" Height="18"/>
										<TextBlock Text="Сотрудники" VerticalAlignment="Center"/>
									</StackPanel>
								</ListBoxItem>
								<ListBoxItem>
									<StackPanel Orientation="Horizontal" Spacing="12">
										<PathIcon Data="{StaticResource organization_regular}" Width="18" Height="18"/>
										<TextBlock Text="Отделы" VerticalAlignment="Center"/>
									</StackPanel>
								</ListBoxItem>
							</ListBox>
						</StackPanel>
					</ScrollViewer>
				</DockPanel>
			</Border>

			<!-- Основной контент -->
			<Border Grid.Column="1" Background="{DynamicResource PrimaryBG}">
				<Grid Margin="24" RowDefinitions="Auto,Auto,*">

					<StackPanel Grid.Row="0" Margin="0,0,0,20">
						<TextBlock Text="{Binding SelectedTabIndex, Converter={conv:Converter Name=IndexToText}, ConverterParameter='Сотрудники|Отделы'}"
                                   FontSize="24" FontWeight="Bold"/>
						<TextBlock Text="{Binding SelectedTabIndex, Converter={conv:Converter Name=IndexToText}, ConverterParameter='Управление учетными записями сотрудников|Структура отделов организации'}"
                                   FontSize="13" Foreground="{DynamicResource TextSecondary}" Margin="0,4,0,0"/>
					</StackPanel>

					<Border Grid.Row="1" Background="{DynamicResource SecondaryBG}"
                            BorderBrush="{DynamicResource BorderDefault}"
                            CornerRadius="16" BorderThickness="1" Padding="16" Margin="0,0,0,16">
						<Grid ColumnDefinitions="*,Auto,Auto">
							<TextBox Grid.Column="0" Classes="Search" Text="{Binding SearchQuery}" Watermark="Поиск...">
								<TextBox.InnerLeftContent>
									<PathIcon Data="{StaticResource search_regular}" Width="16" Height="16"
                                              Margin="12,0,8,0" Foreground="{DynamicResource TextSecondary}"/>
								</TextBox.InnerLeftContent>
							</TextBox>

							<Button Grid.Column="1" Command="{Binding RefreshCommand}"
                                    Classes="IconButton" Margin="12,0,0,0" ToolTip.Tip="Обновить данные">
								<PathIcon Data="{StaticResource refresh_regular}" Width="16" Height="16"
                                          Foreground="{DynamicResource Icon}"/>
							</Button>

							<Button Grid.Column="2" Classes="Primary" Command="{Binding CreateCommand}" Margin="12,0,0,0">
								<StackPanel Orientation="Horizontal" Spacing="8">
									<PathIcon Data="{StaticResource add_regular}" Width="14" Height="14"
                                              Foreground="{DynamicResource TextOnAccent}"/>
									<TextBlock Text="{Binding SelectedTabIndex, Converter={conv:Converter Name=IndexToText}, ConverterParameter='Добавить сотрудника|Создать отдел'}"
                                               Foreground="{DynamicResource TextOnAccent}"/>
								</StackPanel>
							</Button>
						</Grid>
					</Border>

					<Grid Grid.Row="2">
						<!-- Loading -->
						<Border IsVisible="{Binding IsBusy}" Background="{DynamicResource SecondaryBG}"
                                BorderBrush="{DynamicResource BorderDefault}" BorderThickness="1"
                                CornerRadius="16" ZIndex="100">
							<StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="16">
								<ProgressBar IsIndeterminate="True" Width="200"/>
								<TextBlock Text="Загрузка данных..." Foreground="{DynamicResource TextSecondary}"
                                           HorizontalAlignment="Center"/>
							</StackPanel>
						</Border>

						<!-- Error -->
						<Border Classes="AlertError" VerticalAlignment="Top" Margin="0,0,0,16" ZIndex="50"
                                IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
							<Grid ColumnDefinitions="Auto,*">
								<PathIcon Data="{StaticResource warning_regular}" Width="20" Height="20"
                                          Foreground="{DynamicResource DangerBrush}" Margin="0,0,12,0"/>
								<TextBlock Grid.Column="1" Text="{Binding ErrorMessage}"
                                           Foreground="{DynamicResource DangerBrush}" TextWrapping="Wrap"/>
							</Grid>
						</Border>

						<!-- Success -->
						<Border Classes="AlertSuccess" VerticalAlignment="Top" Margin="0,0,0,16" ZIndex="50"
                                IsVisible="{Binding SuccessMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
							<Grid ColumnDefinitions="Auto,*">
								<PathIcon Data="{StaticResource checkmark_regular}" Width="20" Height="20"
                                          Foreground="{DynamicResource SuccessBrush}" Margin="0,0,12,0"/>
								<TextBlock Grid.Column="1" Text="{Binding SuccessMessage}"
                                           Foreground="{DynamicResource SuccessBrush}" TextWrapping="Wrap"/>
							</Grid>
						</Border>

						<!-- Users List -->
						<Border Background="{DynamicResource SecondaryBG}" BorderThickness="1"
                                BorderBrush="{DynamicResource BorderDefault}" CornerRadius="16"
                                IsVisible="{Binding SelectedTabIndex, Converter={conv:Converter Name=Equality}, ConverterParameter=0}">
							<ScrollViewer Padding="16">
								<ItemsControl ItemsSource="{Binding FilteredGroupedUsers}">
									<ItemsControl.ItemsPanel>
										<ItemsPanelTemplate>
											<StackPanel Spacing="20"/>
										</ItemsPanelTemplate>
									</ItemsControl.ItemsPanel>
									<ItemsControl.ItemTemplate>
										<DataTemplate DataType="vm:DepartmentGroup">
											<StackPanel>
												<Grid ColumnDefinitions="Auto,*" Margin="0,0,0,12">
													<Border Background="{DynamicResource CardBgBrush}" CornerRadius="6" Padding="12,6">
														<StackPanel Orientation="Horizontal" Spacing="8">
															<PathIcon Data="{StaticResource organization_regular}" Width="14" Height="14"
                                                                      Foreground="{DynamicResource TextSecondary}"/>
															<TextBlock Text="{Binding DepartmentName}" FontSize="13" FontWeight="SemiBold"/>
														</StackPanel>
													</Border>
													<Border Grid.Column="1" Height="1" Background="{DynamicResource BorderDefault}"
                                                            Margin="12,0,0,0" VerticalAlignment="Center"/>
												</Grid>

												<ItemsControl ItemsSource="{Binding Users}">
													<ItemsControl.ItemsPanel>
														<ItemsPanelTemplate>
															<StackPanel Spacing="8"/>
														</ItemsPanelTemplate>
													</ItemsControl.ItemsPanel>
													<ItemsControl.ItemTemplate>
														<DataTemplate DataType="shared:UserDTO">
															<Border Classes="Hoverable HoverActions"
                                                                    Background="{DynamicResource ItemBgBrush}"
                                                                    CornerRadius="8" Padding="12,10">
																<Grid ColumnDefinitions="Auto,*,Auto">
																	<Border Width="40" Height="40" Background="{DynamicResource CardBgBrush}"
                                                                            CornerRadius="20" Margin="0,0,12,0">
																		<PathIcon Data="{StaticResource person_regular}" Width="18" Height="18"
                                                                                  Foreground="{DynamicResource TextSecondary}"/>
																	</Border>

																	<StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
																		<TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" FontSize="14"/>
																		<TextBlock Text="{Binding Username, StringFormat='@{0}'}"
                                                                                   Foreground="{DynamicResource TextSecondary}" FontSize="12"/>
																	</StackPanel>

																	<StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4" Classes="Actions">
																		<Button Classes="IconButton Small"
                                                                                Command="{Binding DataContext.OpenEditUserDialogCommand, ElementName=Root}"
                                                                                CommandParameter="{Binding .}" ToolTip.Tip="Редактировать">
																			<PathIcon Data="{StaticResource edit_regular}" Width="14" Height="14"
                                                                                      Foreground="{DynamicResource Icon}"/>
																		</Button>
																		<Button Classes="IconButton Small Danger"
                                                                                Command="{Binding DataContext.ToggleBanCommand, ElementName=Root}"
                                                                                CommandParameter="{Binding .}" ToolTip.Tip="Заблокировать">
																			<PathIcon Data="{StaticResource block_regular}" Width="14" Height="14"
                                                                                      Foreground="{DynamicResource Icon}"/>
																		</Button>
																	</StackPanel>
																</Grid>
															</Border>
														</DataTemplate>
													</ItemsControl.ItemTemplate>
												</ItemsControl>
											</StackPanel>
										</DataTemplate>
									</ItemsControl.ItemTemplate>
								</ItemsControl>
							</ScrollViewer>
						</Border>

						<!-- Departments List -->
						<Border Background="{DynamicResource SecondaryBG}" BorderThickness="1"
                                BorderBrush="{DynamicResource BorderDefault}" CornerRadius="16"
                                IsVisible="{Binding SelectedTabIndex, Converter={conv:Converter Name=Equality}, ConverterParameter=1}">
							<ScrollViewer Padding="16">
								<ItemsControl ItemsSource="{Binding FilteredHierarchicalDepartments}"
                                              ItemTemplate="{StaticResource DepartmentTemplate}">
									<ItemsControl.ItemsPanel>
										<ItemsPanelTemplate>
											<StackPanel Spacing="8"/>
										</ItemsPanelTemplate>
									</ItemsControl.ItemsPanel>
								</ItemsControl>
							</ScrollViewer>
						</Border>
					</Grid>
				</Grid>
			</Border>
		</Grid>
	</Border>
</UserControl>