<UserControl xmlns="https://github.com/avaloniaui"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MessengerDesktop.ViewModels"
          xmlns:shared="using:MessengerShared.DTO"
             xmlns:conv="using:MessengerDesktop.Converters"
      xmlns:common="using:MessengerDesktop.Converters.Common"
             xmlns:views="using:MessengerDesktop.Views"
       x:Class="MessengerDesktop.Views.AdminView"
      x:DataType="vm:AdminViewModel"
   x:Name="Root"
	Background="{DynamicResource PrimaryBG}"
      Design.Width="1200" Design.Height="800">

	<UserControl.Resources>
		<ResourceDictionary>
			<DataTemplate x:Key="DepartmentTemplate" DataType="vm:HierarchicalDepartmentViewModel">
				<StackPanel Margin="0,0,0,4">
					<!-- Сам блок -->
					<Border Background="{DynamicResource ThirdBG}"
							Classes="department-item"
							CornerRadius="6"
							Margin="{Binding Level, Converter={conv:Converter Name=LevelToMargin}}">
						<Grid>
							<!-- Горизонтальная линия от родителя -->
							<Border Height="2"
									Width="16"
									Background="Yellow"
									VerticalAlignment="Center"
									HorizontalAlignment="Left"
									Margin="-16,0,0,0"
									IsVisible="{Binding Level, Converter={conv:Converter Name=LevelToVisibility}}"/>

							<!-- Контент -->
							<Border Padding="12,10">
								<Grid ColumnDefinitions="Auto,*,Auto">
									<Button Grid.Column="0"
											Command="{Binding ToggleExpandCommand}"
											IsVisible="{Binding HasChildren}"
											Classes="icon-button"
											Margin="0,0,12,0"
											Padding="4"
											Width="28"
											Height="28"
											Background="#36373D"
											VerticalAlignment="Center">
										<PathIcon Data="{StaticResource chevron_down}">
											<PathIcon.RenderTransform>
												<RotateTransform Angle="{Binding IsExpanded, Converter={conv:Converter Name=BooleanToRotateTransform}}"/>
											</PathIcon.RenderTransform>
										</PathIcon>
									</Button>

									<StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
										<Border Background="{DynamicResource ThirdBG}" Width="36" Height="36" CornerRadius="8">
											<PathIcon Data="{StaticResource organization_regular}" Width="18" Height="18" Opacity="0.8"/>
										</Border>
										<TextBlock Text="{Binding Name}"
												   FontSize="14"
												   FontWeight="Medium"
												   Foreground="{DynamicResource TextPrimary}"
												   VerticalAlignment="Center"/>
									</StackPanel>

									<StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
										<Button Classes="icon-button secondary"
												Command="{Binding DataContext.OpenEditDepartmentCommand, ElementName=Root}"
												CommandParameter="{Binding Department}"
												Width="32" Height="32"
												Background="#36373D"
												ToolTip.Tip="Редактировать отдел">
											<PathIcon Data="{StaticResource edit_regular}" Width="16" Height="16"/>
										</Button>
									</StackPanel>
								</Grid>
							</Border>
						</Grid>
					</Border>

					<!-- Вложенные -->
					<Grid IsVisible="{Binding IsExpanded}" Margin="24,0,0,0">
						<!-- Вертикальная линия, тянущаяся только по количеству детей -->
						<Border Width="2"
								Background="Yellow"
								HorizontalAlignment="Left"
								VerticalAlignment="Top"
								Margin="11,0,0,0"
								Height="{Binding Children.Count, Converter={conv:Converter Name=ChildrenHeight}}"
								IsVisible="{Binding HasChildren}"/>

						<ItemsControl ItemsSource="{Binding Children}"
									  Margin="12,0,0,0"
									  ItemTemplate="{StaticResource DepartmentTemplate}">
							<ItemsControl.ItemsPanel>
								<ItemsPanelTemplate>
									<StackPanel/>
								</ItemsPanelTemplate>
							</ItemsControl.ItemsPanel>
							<ItemsControl.Transitions>
								<Transitions>
									<DoubleTransition Property="Opacity" Duration="0:0:0.2"/>
								</Transitions>
							</ItemsControl.Transitions>
						</ItemsControl>
					</Grid>
				</StackPanel>
			</DataTemplate>
		</ResourceDictionary>
	</UserControl.Resources>

	<Grid>
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="240"/>
			<ColumnDefinition Width="*"/>
		</Grid.ColumnDefinitions>
		<Border Background="{DynamicResource PrimaryBG}"
                BorderThickness="1,0,0,0" BorderBrush="{DynamicResource BorderDefault}">
			<DockPanel Margin="16,24">
				<TextBlock Text="Панель"
                         DockPanel.Dock="Top"
                         FontSize="24"
                         FontWeight="Bold"
                         Foreground="White"
                         Margin="8,0,0,24"/>

				<ListBox SelectedIndex="{Binding SelectedTabIndex}"
                        Background="Transparent"
                        BorderThickness="0">
					<ListBox.Styles>
						<Style Selector="ListBoxItem">
							<Setter Property="Padding" Value="12,8"/>
							<Setter Property="Margin" Value="0,2"/>
							<Setter Property="CornerRadius" Value="4"/>
						</Style>
						<Style Selector="ListBoxItem:selected">
							<Setter Property="Background" Value="#404149"/>
						</Style>
					</ListBox.Styles>

					<ListBoxItem>
						<StackPanel Orientation="Horizontal" Spacing="12">
							<PathIcon Data="{StaticResource person_regular}"
                                    Width="20" Height="20"/>
							<TextBlock Text="Сотрудники"
                                     VerticalAlignment="Center"/>
						</StackPanel>
					</ListBoxItem>
					<ListBoxItem>
						<StackPanel Orientation="Horizontal" Spacing="12">
							<PathIcon Data="{StaticResource organization_regular}"
                                    Width="20" Height="20"/>
							<TextBlock Text="Отделы"
                                     VerticalAlignment="Center"/>
						</StackPanel>
					</ListBoxItem>
				</ListBox>
			</DockPanel>
		</Border>

		<!-- Content Area -->
		<Border Grid.Column="1" CornerRadius="8" Background="{DynamicResource SecondaryBG}" BorderBrush="{DynamicResource BorderDefault}" BorderThickness="1">
			<Grid Margin="24">
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
				</Grid.RowDefinitions>

				<!-- Header -->
				<Grid ColumnDefinitions="*,Auto,Auto"
					  Margin="0,0,0,16">
					<TextBox Grid.Column="0"
							Classes="search"
							Text="{Binding SearchQuery}"
							Watermark="Поиск..."
							Margin="0,0,16,0">
						<TextBox.InnerLeftContent>
							<PathIcon Data="{StaticResource search_regular}"
									Width="16" Height="16"
									Margin="12,0,8,0"
									Opacity="0.5"/>
						</TextBox.InnerLeftContent>
					</TextBox>

					<Button Grid.Column="1"
							Command="{Binding RefreshCommand}"
							Classes="icon-button"
							Margin="0,0,8,0"
							ToolTip.Tip="Refresh">
						<PathIcon Data="{StaticResource refresh_regular}"
								Width="16" Height="16"/>
					</Button>

					<Button Grid.Column="2"
							Classes="accent"
							Command="{Binding CreateCommand}">
						<StackPanel Orientation="Horizontal"
								  Spacing="8">
							<PathIcon Data="{StaticResource add_regular}"
									Width="16" Height="16"/>
							<TextBlock Text="{Binding SelectedTabIndex, Converter={conv:Converter Name=IndexToText}, ConverterParameter='Создать пользователя|Создать Отдел'}"/>
						</StackPanel>
					</Button>
				</Grid>

				<!-- Content -->
				<Grid Grid.Row="1">
					<!-- Loading indicator -->
					<ProgressBar IsIndeterminate="True"
								IsVisible="{Binding IsLoading}"
								VerticalAlignment="Top"
								Height="2"
								Margin="0,-8,0,0"/>

					<!-- Error message -->
					<TextBlock Text="{Binding ErrorMessage}"
							  IsVisible="{Binding ErrorMessage, Converter={conv:Converter Name=StringNotNullOrEmpty}}"
							  Foreground="#C42B1C"
							  HorizontalAlignment="Center"
							  VerticalAlignment="Top"
							  Margin="0,8,0,0"/>

					<!-- Main Content -->
					<Border Background="{DynamicResource SecondaryBG}"
							CornerRadius="12"
							Padding="20"
							Margin="0,24,0,0">
						<Grid>
							<!-- Users List -->
							<ScrollViewer IsVisible="{Binding SelectedTabIndex, Converter={conv:Converter Name=Equality}, ConverterParameter=0}">
								<ItemsControl ItemsSource="{Binding FilteredGroupedUsers}">
									<ItemsControl.ItemTemplate>
										<DataTemplate>
											<StackPanel Margin="0,0,0,16">
												<Border Background="#36373D"
														CornerRadius="4"
														Padding="12,8"
														Margin="0,0,0,8">
													<TextBlock Text="{Binding DepartmentName}"
															 FontSize="14"
															 FontWeight="SemiBold"
															 Foreground="White"/>
												</Border>

												<ItemsControl ItemsSource="{Binding Users}">
													<ItemsControl.ItemTemplate>
														<DataTemplate>
															<Border Classes="department"
																	Margin="0,0,0,4"
																	Background="#2B2D31"
																	CornerRadius="4"
																	Padding="12,8">
																<Grid ColumnDefinitions="Auto,*,Auto">
																	<Border Width="32"
																			Height="32"
																			Background="#36373D"
																			CornerRadius="16"
																			Margin="0,0,12,0">
																		<PathIcon Data="{StaticResource person_regular}"
																				Width="16"
																				Height="16"/>
																	</Border>

																	<StackPanel Grid.Column="1"
																			  VerticalAlignment="Center">
																		<TextBlock Text="{Binding DisplayName}"
																				 FontWeight="Medium"
																				 Foreground="White"/>
																		<TextBlock Text="{Binding Username}"
																				 Foreground="#A0A0A0"
																				 FontSize="11"/>
																	</StackPanel>

																	<StackPanel Grid.Column="2"
																			  Orientation="Horizontal"
																			  Spacing="4">
																		<Button Classes="icon-button"
																				Command="{Binding DataContext.OpenEditUserDialogCommand, ElementName=Root}"
																				CommandParameter="{Binding .}"
																				ToolTip.Tip="Редактировать сотрудника">
																			<PathIcon Data="{StaticResource edit_regular}"
																					Width="16" Height="16"/>
																		</Button>
																		<Button Classes="icon-button danger"
																				Command="{Binding DataContext.ToggleBanCommand, ElementName=Root}"
																				CommandParameter="{Binding .}"
																				ToolTip.Tip="Заблокировать пользователя">
																			<PathIcon Data="{StaticResource block_regular}"
																					Width="16" Height="16"/>
																		</Button>
																	</StackPanel>
																</Grid>
															</Border>
														</DataTemplate>
													</ItemsControl.ItemTemplate>
												</ItemsControl>
											</StackPanel>
										</DataTemplate>
									</ItemsControl.ItemTemplate>
								</ItemsControl>
							</ScrollViewer>

							<ScrollViewer IsVisible="{Binding SelectedTabIndex, Converter={conv:Converter Name=Equality}, ConverterParameter=1}">
								<ItemsControl ItemsSource="{Binding FilteredHierarchicalDepartments}"
											ItemTemplate="{StaticResource DepartmentTemplate}"/>
							</ScrollViewer>
						</Grid>
					</Border>
				</Grid>
			</Grid>
		</Border>
		<!--сюда-->
		<Grid IsVisible="{Binding IsUserDialogOpen}"
              Background="#80000000"
              Grid.ColumnSpan="2"
			  
              ZIndex="1000">
			<views:UserEditDialog DataContext="{Binding UserDialogViewModel}" Height="250"/>
		</Grid>

		<Grid IsVisible="{Binding IsDepartmentDialogOpen}"
              Background="#80000000"
              Grid.ColumnSpan="2"
              ZIndex="1000">
			<Border Background="{DynamicResource SecondaryBG}"
                    CornerRadius="12"
                    Width="400"
                    Padding="24" Height="250">
				<StackPanel>
					<TextBlock Text="{Binding DepartmentDialogViewModel.IsNewDepartment, Converter={conv:Converter Name=BoolToString}, ConverterParameter='Создать отдел|Редактировать отдел'}"
                             FontSize="20"
                             FontWeight="Bold"
                             Margin="0,0,0,16"/>

					<TextBox Text="{Binding DepartmentDialogViewModel.Name}"
                            Classes="clearButton"
                            Watermark="Название отдела"
                            Margin="0,0,0,12"/>

					<ComboBox ItemsSource="{Binding DepartmentDialogViewModel.Departments}"
                             SelectedItem="{Binding DepartmentDialogViewModel.SelectedParent}"
                             PlaceholderText="Выбрать родительский отдел"
                             Margin="0,0,0,24">
						<ComboBox.ItemTemplate>
							<DataTemplate>
								<TextBlock Text="{Binding Name}"/>
							</DataTemplate>
						</ComboBox.ItemTemplate>
					</ComboBox>

					<StackPanel Orientation="Horizontal"
                              HorizontalAlignment="Right"
                              Spacing="12">
						<Button Content="Отмена"
                                Classes="outline"
                                Command="{Binding DepartmentDialogViewModel.CancelCommand}"/>
						<Button Content="Сохранить"
                                Classes="accent"
                                Command="{Binding DepartmentDialogViewModel.SaveCommand}"/>
					</StackPanel>
				</StackPanel>
			</Border>
		</Grid>
	</Grid>

	<UserControl.Styles>
		<!-- Button Styles -->
		<Style Selector="Button.outline">
			<Setter Property="Background" Value="Transparent"/>
			<Setter Property="BorderBrush" Value="#0078D4"/>
			<Setter Property="BorderThickness" Value="1"/>
			<Setter Property="Padding" Value="16,8"/>
			<Setter Property="CornerRadius" Value="4"/>
		</Style>

		<Style Selector="Button.accent">
			<Setter Property="Background" Value="#0078D4"/>
			<Setter Property="Foreground" Value="White"/>
			<Setter Property="Padding" Value="16,8"/>
			<Setter Property="CornerRadius" Value="4"/>
		</Style>

		<Style Selector="Button.icon-button">
			<Setter Property="Width" Value="32"/>
			<Setter Property="Height" Value="32"/>
			<Setter Property="Background" Value="#36373D"/>
			<Setter Property="CornerRadius" Value="4"/>
			<Setter Property="Transitions">
				<Transitions>
					<BrushTransition Property="Background" Duration="0:0:0.15"/>
				</Transitions>
			</Setter>
		</Style>

		<Style Selector="Button.icon-button:pointerover">
			<Setter Property="Background" Value="#404149"/>
		</Style>

		<!-- Department List Styles -->
		<Style Selector="Border.department-item">
			<Setter Property="Transitions">
				<Transitions>
					<BrushTransition Property="Background" Duration="0:0:0.15"/>
				</Transitions>
			</Setter>
			<!--<Setter Property="BoxShadow" Value="0 2px 4px 0 #1A1B1E"/>-->
		</Style>

		<Style Selector="Border.department-item:pointerover">
			<Setter Property="Background" Value="#32343A"/>
		</Style>

		<!-- Input Control Styles -->
		<Style Selector="TextBox.clearButton">
			<Setter Property="Background" Value="#2B2D31"/>
			<Setter Property="Height" Value="36"/>
			<Setter Property="CornerRadius" Value="4"/>
			<Setter Property="BorderThickness" Value="1"/>
			<Setter Property="BorderBrush" Value="#404149"/>
		</Style>

		<Style Selector="ComboBox">
			<Setter Property="Background" Value="#2B2D31"/>
			<Setter Property="Height" Value="36"/>
			<Setter Property="CornerRadius" Value="4"/>
			<Setter Property="BorderThickness" Value="1"/>
			<Setter Property="BorderBrush" Value="#404149"/>
		</Style>
	</UserControl.Styles>
</UserControl>