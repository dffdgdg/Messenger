<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:MessengerDesktop.Controls"
             xmlns:asyncImageLoader="clr-namespace:AsyncImageLoader;assembly=AsyncImageLoader.Avalonia"
             x:Class="MessengerDesktop.Controls.AvatarControl"
             x:Name="Root">

    <UserControl.Styles>
        <Style Selector="controls|AvatarControl.Small">
            <Setter Property="Size" Value="32"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="IconSize" Value="14"/>
        </Style>
        <Style Selector="controls|AvatarControl.Medium">
            <Setter Property="Size" Value="40"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="IconSize" Value="18"/>
        </Style>
        <Style Selector="controls|AvatarControl.Large">
            <Setter Property="Size" Value="56"/>
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="IconSize" Value="24"/>
        </Style>
        <Style Selector="controls|AvatarControl.XLarge">
            <Setter Property="Size" Value="80"/>
            <Setter Property="FontSize" Value="28"/>
            <Setter Property="IconSize" Value="32"/>
        </Style>
        <Style Selector="controls|AvatarControl.XXLarge">
            <Setter Property="Size" Value="100"/>
            <Setter Property="FontSize" Value="36"/>
            <Setter Property="IconSize" Value="40"/>
        </Style>
    </UserControl.Styles>

    <Panel Width="{Binding Size, ElementName=Root}"
           Height="{Binding Size, ElementName=Root}">

        <Border x:Name="AvatarBorder"
                ClipToBounds="True"
                Background="{Binding PlaceholderBackground, ElementName=Root}">

            <Panel>
                <!--
                    CRITICAL: Wrap Image in a Panel with IsVisible=HasImage.
                    
                    WHY: AsyncImageLoader evaluates its Source binding
                    even when the Image itself has IsVisible=false.
                    By collapsing the PARENT Panel, the Image control
                    is removed from the visual tree entirely, and
                    AsyncImageLoader never fires.
                    
                    Without this wrapper:
                    - Source=null → AsyncImageLoader tries to load "" → error
                    - Source="file.pptx" → tries to decode as bitmap → crash
                    - Source="avatar.webp" but no token → 401 → log spam
                -->
                <Panel IsVisible="{Binding HasImage, ElementName=Root}">
                    <Image x:Name="AvatarImage"
                           Stretch="UniformToFill"
                           asyncImageLoader:ImageLoader.Source="{Binding ImageSource, ElementName=Root}"/>
                </Panel>

                <!-- Initials placeholder -->
                <TextBlock Text="{Binding Initials, ElementName=Root}"
                           FontSize="{Binding FontSize, ElementName=Root}"
                           FontWeight="SemiBold"
                           Foreground="{Binding PlaceholderForeground, ElementName=Root}"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           IsVisible="{Binding ShowInitials, ElementName=Root}"/>

                <!-- Icon placeholder -->
                <PathIcon Data="{Binding IconData, ElementName=Root}"
                          Width="{Binding IconSize, ElementName=Root}"
                          Height="{Binding IconSize, ElementName=Root}"
                          Foreground="{Binding PlaceholderForeground, ElementName=Root}"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          IsVisible="{Binding ShowIcon, ElementName=Root}"/>
            </Panel>
        </Border>

        <!-- Online indicator -->
        <Border x:Name="OnlineIndicator"
                IsVisible="{Binding ShowOnlineStatus, ElementName=Root}"
                Width="{Binding OnlineIndicatorSize, ElementName=Root}"
                Height="{Binding OnlineIndicatorSize, ElementName=Root}"
                CornerRadius="{Binding OnlineIndicatorCornerRadius, ElementName=Root}"
                Background="{DynamicResource OnlineStatus}"
                BorderBrush="{DynamicResource PrimaryBG}"
                BorderThickness="2"
                HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                Margin="0,0,-2,-2"/>
    </Panel>
</UserControl>