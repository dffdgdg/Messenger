<UserControl x:Name="Root"
             xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:MessengerDesktop.ViewModels"
             xmlns:conv="clr-namespace:MessengerDesktop.Converters;assembly=MessengerDesktop"
             xmlns:controls="using:MessengerDesktop.Controls"
             x:Class="MessengerDesktop.Views.ChatEditDialog"
             x:DataType="vm:ChatEditDialogViewModel"
             mc:Ignorable="d"
             d:DesignWidth="450" d:DesignHeight="600">

    <Border Classes="DialogContainer" Width="450" MaxHeight="650"
			Background="{DynamicResource SecondaryBG}">
        <Grid RowDefinitions="Auto,*,Auto">
            
            <!-- Заголовок -->
            <StackPanel Grid.Row="0" Spacing="16" Margin="0,0,0,16">
                <TextBlock Text="{Binding Title}"
                           FontWeight="Bold"
                           FontSize="20"/>

                <!-- Аватар и название -->
                <Grid ColumnDefinitions="Auto,*" Margin="0,8,0,0">
                    <!-- Аватар группы -->
                    <Grid Grid.Column="0" 
                          Width="80" Height="80" 
                          Margin="0,0,16,0">

                       <controls:AvatarControl Classes="XLarge"
                                                Source="{Binding AvatarPreview}"
                                                FallbackIcon="{StaticResource GroupIcon}"
                                                ShowOnlineIndicator="False"
                                                PlaceholderBackground="{DynamicResource SurfaceVariant}"
                                                PlaceholderForeground="{DynamicResource TextSecondary}"/>

                        <!-- Кнопка выбора аватара -->
                        <Button Classes="IconButton"
                                Width="28" Height="28"
                                CornerRadius="14"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Bottom"
                                Command="{Binding SelectAvatarCommand}"
                                ToolTip.Tip="Выбрать аватар">
                            <Path Data="{StaticResource CameraIcon}"
                                  Width="14" Height="14"
                                  Stretch="Uniform"
                                  Fill="{DynamicResource TextPrimary}"/>
                        </Button>

                        <!-- Кнопка удаления аватара -->
                        <Button Classes="IconButton"
                                Width="20" Height="20"
                                CornerRadius="10"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Top"
                                Margin="0,-4,-4,0"
                                Command="{Binding ClearAvatarCommand}"
                                IsVisible="{Binding AvatarPreview, Converter={x:Static ObjectConverters.IsNotNull}}"
                                ToolTip.Tip="Удалить аватар">
                            <Path Data="{StaticResource CloseIcon}"
                                  Width="8" Height="8"
                                  Stretch="Uniform"
                                  Fill="{DynamicResource TextSecondary}"/>
                        </Button>
                    </Grid>

                    <!-- Название группы -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="4">
                        <TextBlock Text="Название группы" 
                                   FontWeight="DemiBold"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextSecondary}"/>
                        <TextBox Text="{Binding Name}"
                                 Watermark="Введите название..."
                                 Classes="DialogInput"
                                 MaxLength="100"/>
                    </StackPanel>
                </Grid>
            </StackPanel>

            <!-- Список участников -->
            <Grid Grid.Row="1" RowDefinitions="Auto,Auto,*">
                <!-- Заголовок с счётчиком -->
                <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,8">
                    <TextBlock Grid.Column="0" VerticalAlignment="Center">
                        <Run Text="Участники" FontWeight="DemiBold"/>
                        <Run Text=" ("/>
                        <Run Text="{Binding SelectedUsersCount}"/>
                        <Run Text=" выбрано)"/>
                    </TextBlock>
                    
                    <StackPanel Grid.Column="1" 
                                Orientation="Horizontal" 
                                Spacing="8">
                        <Button Content="Все"
                                Classes="TextButton"
                                Command="{Binding SelectAllCommand}"
                                FontSize="12"/>
                        <Button Content="Снять"
                                Classes="TextButton"
                                Command="{Binding DeselectAllCommand}"
                                FontSize="12"/>
                    </StackPanel>
                </Grid>

                <!-- Поиск пользователей -->
                <TextBox Grid.Row="1"
                         Text="{Binding SearchUserQuery}"
                         Watermark="Поиск пользователей..."
                         Classes="DialogInput SearchInput"
                         Margin="0,0,0,8"/>

                <!-- Индикатор загрузки -->
        <StackPanel Grid.Row="2"
            IsVisible="{Binding IsBusy}"
            VerticalAlignment="Center"
            HorizontalAlignment="Center">
    <ProgressBar IsIndeterminate="True"
                 Width="32" Height="32"/>
    <TextBlock Text="Загрузка пользователей..."
               Margin="0,8,0,0"
               Foreground="{DynamicResource TextSecondary}"/>
</StackPanel>
    
                <!-- Список пользователей -->
                <Border Grid.Row="2"
                        BorderThickness="1"
                        BorderBrush="{DynamicResource BorderBrush}"
                        CornerRadius="8"
                        IsVisible="{Binding !IsBusy}">
                    <ScrollViewer HorizontalScrollBarVisibility="Disabled"
                                  VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding FilteredUsers}"
                                      Margin="4">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:ChatEditDialogViewModel+SelectableUserItem">
                                    <Border Padding="8,6"
                                            CornerRadius="6"
                                            Cursor="Hand"
                                            Background="Transparent"
                                            PointerPressed="OnUserItemPressed">
                                        <Border.Styles>
                                            <Style Selector="Border:pointerover">
                                                <Setter Property="Background" 
                                                        Value="{DynamicResource SurfaceHover}"/>
                                            </Style>
                                        </Border.Styles>
                                        
                                        <Grid ColumnDefinitions="Auto,Auto,*,Auto">
                                            <!-- Чекбокс -->
                                            <CheckBox Grid.Column="0"
                                                      IsChecked="{Binding IsSelected}"
                                                      Margin="0,0,12,0"
                                                      VerticalAlignment="Center"/>

                                            <!-- Аватар -->
                                            <controls:AvatarControl Grid.Column="1"
                                                                    Size="36"
                                                                    FontSize="14"
                                                                    IconSize="16"
                                                                    Source="{Binding AvatarUrl}"
                                                                    DisplayName="{Binding DisplayName}"
                                                                    ShowOnlineIndicator="False"
                                                                    PlaceholderBackground="{DynamicResource AccentLight}"
                                                                    PlaceholderForeground="{DynamicResource AccentForeground}"
                                                                    Margin="0,0,12,0"/>

                                            <StackPanel Grid.Column="2" 
                                                        VerticalAlignment="Center"
                                                        Spacing="2">
                                                <TextBlock Text="{Binding DisplayName}"
                                                           FontWeight="Medium"
                                                           TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Text="{Binding Username}"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource TextSecondary}"
                                                           TextTrimming="CharacterEllipsis"/>
                                            </StackPanel>

                                            <Path Grid.Column="3"
                                                  Data="{StaticResource CheckIcon}"
                                                  Width="16" Height="16"
                                                  Stretch="Uniform"
                                                  Fill="{DynamicResource AccentColor}"
                                                  VerticalAlignment="Center"
                                                  IsVisible="{Binding IsSelected}"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Border>

                <!-- Пустой список -->
                <TextBlock Grid.Row="2"
                           Text="Пользователи не найдены"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource TextSecondary}"
                           IsVisible="{Binding FilteredUsers.Count, 
                                      Converter={conv:Converter Name=ZeroToTrue}}"/>
            </Grid>

			<!-- Нижняя панель -->
			<StackPanel Grid.Row="2" Spacing="12" Margin="0,16,0,0">
				<!-- Сообщения об ошибках/успехе -->
				<TextBlock Text="{Binding ErrorMessage}"
						   Foreground="{DynamicResource ErrorColor}"
						   TextWrapping="Wrap"
						   IsVisible="{Binding ErrorMessage, 
                          Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

				<TextBlock Text="{Binding SuccessMessage}"
						   Foreground="{DynamicResource SuccessColor}"
						   TextWrapping="Wrap"
						   IsVisible="{Binding SuccessMessage, 
                          Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

				<!-- Кнопки -->
				<StackPanel Orientation="Horizontal"
							HorizontalAlignment="Right"
							Spacing="12">
					<Button Content="Отмена"
							Classes="DialogOutline"
							Command="{Binding CancelCommand}"
							MinWidth="100"/>
					<Button Classes="DialogAccent"
							Content="{Binding IsNewChat, 
                             Converter={conv:Converter Name=BoolToString}, 
                             ConverterParameter='Создать|Сохранить'}"
							Command="{Binding SaveCommand}"
							IsEnabled="{Binding CanSave}"
							MinWidth="100">
					</Button>
				</StackPanel>
			</StackPanel>
        </Grid>
    </Border>
</UserControl>