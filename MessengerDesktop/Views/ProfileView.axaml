<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MessengerDesktop.ViewModels"
             xmlns:controls="using:MessengerDesktop.Controls"
             x:Class="MessengerDesktop.Views.ProfileView"
             x:DataType="vm:ProfileViewModel"
             Background="{DynamicResource PrimaryBG}">

	<UserControl.Styles>
		<!-- Оверлей аватара при наведении -->
		<Style Selector="Button.AvatarButton:pointerover Border#AvatarOverlay">
			<Setter Property="Opacity" Value="1"/>
		</Style>

		<!-- Стиль для полей с ошибкой -->
		<Style Selector="TextBox.HasError">
			<Setter Property="BorderBrush" Value="{DynamicResource ErrorBrush}"/>
		</Style>

		<!-- Стиль для полей с успехом -->
		<Style Selector="TextBox.HasSuccess">
			<Setter Property="BorderBrush" Value="{DynamicResource SuccessBrush}"/>
		</Style>
	</UserControl.Styles>

	<Border Classes="PageContainer">
		<ScrollViewer VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled"
                      Classes="ThinScrollbar">
			<Border Padding="32,24">
				<Grid HorizontalAlignment="Center">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*" MaxWidth="560"/>
					</Grid.ColumnDefinitions>

					<StackPanel Spacing="20">

						<!-- Заголовок -->
						<TextBlock Text="Профиль"
                                   Classes="PageTitle"
                                   Margin="0,0,0,8"/>

						<!-- ═══════════════════════════════════════════════════════ -->
						<!-- АВАТАР И ОСНОВНАЯ ИНФОРМАЦИЯ -->
						<!-- ═══════════════════════════════════════════════════════ -->
						<Border Classes="ProfileSection">
							<Grid ColumnDefinitions="Auto,*">

								<!-- Аватар -->
								<Button Classes="AvatarButton IconButton"
                                        Width="88" Height="88"
                                        Command="{Binding UploadAvatarCommand}"
                                        ToolTip.Tip="Изменить аватар">
									<Panel>
										<controls:AvatarControl Classes="XLarge"
                                                                Source="{Binding User.Avatar}"
                                                                DisplayName="{Binding FullName}"
                                                                ShowOnlineIndicator="False"/>

										<Border x:Name="AvatarOverlay"
                                                Width="88" Height="88"
                                                CornerRadius="44"
                                                Background="#80000000"
                                                Opacity="0">
											<Border.Transitions>
												<Transitions>
													<DoubleTransition Property="Opacity" Duration="0:0:0.15"/>
												</Transitions>
											</Border.Transitions>
											<PathIcon Data="{StaticResource camera_regular}"
                                                      Width="24" Height="24"
                                                      Foreground="White"/>
										</Border>
									</Panel>
								</Button>

								<!-- Имя и username -->
								<StackPanel Grid.Column="1"
                                            VerticalAlignment="Center"
                                            Spacing="6"
                                            Margin="20,0,0,0">
									<TextBlock Text="{Binding FullName}"
                                               FontSize="20"
                                               FontWeight="SemiBold"
                                               TextTrimming="CharacterEllipsis"/>
									<StackPanel Orientation="Horizontal" Spacing="2">
										<TextBlock Text="@"
                                                   FontSize="14"
                                                   Foreground="{DynamicResource TextMuted}"/>
										<TextBlock Text="{Binding User.Username, FallbackValue='username'}"
                                                   FontSize="14"
                                                   Foreground="{DynamicResource TextSecondary}"/>
									</StackPanel>
								</StackPanel>
							</Grid>
						</Border>

						<!-- ═══════════════════════════════════════════════════════ -->
						<!-- ЛИЧНЫЕ ДАННЫЕ (ФИО) -->
						<!-- ═══════════════════════════════════════════════════════ -->
						<Border Classes="ProfileSection">
							<StackPanel Spacing="16">

								<!-- Заголовок секции -->
								<Grid ColumnDefinitions="Auto,*,Auto">
									<StackPanel Orientation="Horizontal" Spacing="10">
										<PathIcon Data="{StaticResource ProfileIcon}"
                                                  Width="18" Height="18"
                                                  Foreground="{DynamicResource Accent}"/>
										<TextBlock Text="Личные данные"
                                                   FontSize="15"
                                                   FontWeight="SemiBold"/>
									</StackPanel>

									<!-- Кнопка редактирования (когда не редактируем) -->
									<Button Grid.Column="2"
                                            Classes="IconButton Small"
                                            Command="{Binding StartEditProfileCommand}"
                                            IsVisible="{Binding !IsEditingProfile}"
                                            ToolTip.Tip="Редактировать">
										<PathIcon Data="{StaticResource edit_regular}"
                                                  Width="16" Height="16"
                                                  Foreground="{DynamicResource TextSecondary}"/>
									</Button>
								</Grid>

								<!-- Режим просмотра -->
								<StackPanel Spacing="12" IsVisible="{Binding !IsEditingProfile}">
									<Grid RowDefinitions="Auto,Auto,Auto"
                                          ColumnDefinitions="90,*"
                                          RowSpacing="10">

										<TextBlock Text="Фамилия"
                                                   Classes="FieldLabel"
                                                   Opacity="0.7"/>
										<TextBlock Grid.Column="1"
                                                   Text="{Binding User.Surname, TargetNullValue='Не указана'}"
                                                   FontSize="14"
												   />

										<TextBlock Grid.Row="1"
                                                   Text="Имя"
                                                   Classes="FieldLabel"
                                                   Opacity="0.7"/>
										<TextBlock Grid.Row="1" Grid.Column="1"
                                                   Text="{Binding User.Name, TargetNullValue='Не указано'}"
                                                   FontSize="14"/>

										<TextBlock Grid.Row="2"
                                                   Text="Отчество"
                                                   Classes="FieldLabel"
                                                   Opacity="0.7"/>
										<TextBlock Grid.Row="2" Grid.Column="1"
                                                   Text="{Binding User.Midname, TargetNullValue='Не указано'}"
                                                   FontSize="14"/>
									</Grid>
								</StackPanel>

								<!-- Режим редактирования -->
								<StackPanel Spacing="16" IsVisible="{Binding IsEditingProfile}">

									<!-- Превью имени -->
									<Border Background="{DynamicResource AccentMuted}"
                                            CornerRadius="8"
                                            Padding="12,10">
										<Grid ColumnDefinitions="Auto,*">
											<TextBlock Text="Отображается как:"
                                                       FontSize="12"
                                                       Foreground="{DynamicResource TextSecondary}"
                                                       VerticalAlignment="Center"/>
											<TextBlock Grid.Column="1"
                                                       Text="{Binding TempFullName}"
                                                       FontSize="14"
                                                       FontWeight="Medium"
                                                       Margin="8,0,0,0"
                                                       VerticalAlignment="Center"/>
										</Grid>
									</Border>

									<!-- Поля ввода -->
									<Grid ColumnDefinitions="*,*,*" ColumnSpacing="12">
										<StackPanel Spacing="6">
											<TextBlock Text="Фамилия"
                                                       Classes="FieldLabel"
                                                       FontSize="12"/>
											<TextBox Text="{Binding TempSurname}"
                                                     Classes="DialogInput"
                                                     Watermark="Иванов"/>
										</StackPanel>

										<StackPanel Grid.Column="1" Spacing="6">
											<TextBlock Text="Имя"
                                                       Classes="FieldLabel"
                                                       FontSize="12"/>
											<TextBox Text="{Binding TempName}"
                                                     Classes="DialogInput"
                                                     Watermark="Иван"/>
										</StackPanel>

										<StackPanel Grid.Column="2" Spacing="6">
											<TextBlock Text="Отчество"
                                                       Classes="FieldLabel"
                                                       FontSize="12"/>
											<TextBox Text="{Binding TempMidname}"
                                                     Classes="DialogInput"
                                                     Watermark="Иванович"/>
										</StackPanel>
									</Grid>

									<!-- Кнопки -->
									<StackPanel Orientation="Horizontal" Spacing="10">
										<Button Content="Сохранить"
                                                Classes="DialogAccent"
                                                Command="{Binding SaveProfileCommand}"
                                                Padding="20,8"/>
										<Button Content="Отмена"
                                                Classes="DialogOutline"
                                                Command="{Binding CancelEditProfileCommand}"
                                                Padding="16,8"/>
									</StackPanel>
								</StackPanel>
							</StackPanel>
						</Border>

						<!-- ═══════════════════════════════════════════════════════ -->
						<!-- USERNAME -->
						<!-- ═══════════════════════════════════════════════════════ -->
						<Border Classes="ProfileSection">
							<StackPanel Spacing="16">

								<!-- Заголовок секции -->
								<Grid ColumnDefinitions="Auto,*,Auto">
									<StackPanel Orientation="Horizontal" Spacing="10">
										<PathIcon Data="{StaticResource mention_regular}"
                                                  Width="18" Height="18"
                                                  Foreground="{DynamicResource Accent}"/>
										<TextBlock Text="Имя пользователя"
                                                   FontSize="15"
                                                   FontWeight="SemiBold"/>
									</StackPanel>

									<Button Grid.Column="2"
                                            Classes="IconButton Small"
                                            Command="{Binding StartEditUsernameCommand}"
                                            IsVisible="{Binding !IsEditingUsername}"
                                            ToolTip.Tip="Изменить">
										<PathIcon Data="{StaticResource edit_regular}"
                                                  Width="16" Height="16"
                                                  Foreground="{DynamicResource TextSecondary}"/>
									</Button>
								</Grid>

								<!-- Режим просмотра -->
								<Grid ColumnDefinitions="90,*"
                                      IsVisible="{Binding !IsEditingUsername}">
									<TextBlock Text="Username"
                                               Classes="FieldLabel"
                                               Opacity="0.7"/>
									<StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="2">
										<TextBlock Text="@"
                                                   FontSize="14"
                                                   Foreground="{DynamicResource TextMuted}"/>
										<TextBlock Text="{Binding User.Username}"
                                                   FontSize="14"/>
									</StackPanel>
								</Grid>

								<!-- Режим редактирования -->
								<StackPanel Spacing="14" IsVisible="{Binding IsEditingUsername}">
									<StackPanel Spacing="6">
										<TextBlock Text="Новый username"
                                                   Classes="FieldLabel"
                                                   FontSize="12"/>
										<Grid ColumnDefinitions="Auto,*">
											<Border Background="{DynamicResource ControlBg}"
                                                    BorderBrush="{DynamicResource ControlBorder}"
                                                    BorderThickness="1,1,0,1"
                                                    CornerRadius="8,0,0,8"
                                                    Padding="12,0"
                                                    Height="40">
												<TextBlock Text="@"
                                                           VerticalAlignment="Center"
                                                           FontSize="14"
                                                           Foreground="{DynamicResource TextMuted}"/>
											</Border>
											<TextBox Grid.Column="1"
                                                     Text="{Binding TempUsername}"
                                                     Classes="DialogInput"
                                                     CornerRadius="0,8,8,0"
                                                     Watermark="username"
                                                     MaxLength="30"/>
										</Grid>

										<!-- Подсказка / Ошибка -->
										<Panel Height="16">
											<TextBlock Text="{Binding UsernameValidationMessage}"
                                                       FontSize="11"
                                                       Foreground="{DynamicResource ErrorBrush}"
                                                       IsVisible="{Binding UsernameValidationMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
											<TextBlock Text="Латинские буквы, цифры и подчёркивания (3-30 символов)"
                                                       FontSize="11"
                                                       Foreground="{DynamicResource TextMuted}"
                                                       IsVisible="{Binding UsernameValidationMessage, Converter={x:Static StringConverters.IsNullOrEmpty}}"/>
										</Panel>
									</StackPanel>

									<StackPanel Orientation="Horizontal" Spacing="10">
										<Button Content="Сохранить"
                                                Classes="DialogAccent"
                                                Command="{Binding SaveUsernameCommand}"
                                                IsEnabled="{Binding CanSaveUsername}"
                                                Padding="20,8"/>
										<Button Content="Отмена"
                                                Classes="DialogOutline"
                                                Command="{Binding CancelEditUsernameCommand}"
                                                Padding="16,8"/>
									</StackPanel>
								</StackPanel>
							</StackPanel>
						</Border>

						<!-- ═══════════════════════════════════════════════════════ -->
						<!-- БЕЗОПАСНОСТЬ (ПАРОЛЬ) -->
						<!-- ═══════════════════════════════════════════════════════ -->
						<Border Classes="ProfileSection">
							<StackPanel Spacing="16">

								<!-- Заголовок секции -->
								<Grid ColumnDefinitions="Auto,*,Auto">
									<StackPanel Orientation="Horizontal" Spacing="10">
										<PathIcon Data="{StaticResource lock_closed_regular}"
                                                  Width="18" Height="18"
                                                  Foreground="{DynamicResource Accent}"/>
										<TextBlock Text="Безопасность"
                                                   FontSize="15"
                                                   FontWeight="SemiBold"/>
									</StackPanel>

									<Button Grid.Column="2"
                                            Classes="IconButton Small"
                                            Command="{Binding StartEditPasswordCommand}"
                                            IsVisible="{Binding !IsEditingPassword}"
                                            ToolTip.Tip="Изменить пароль">
										<PathIcon Data="{StaticResource edit_regular}"
                                                  Width="16" Height="16"
                                                  Foreground="{DynamicResource TextSecondary}"/>
									</Button>
								</Grid>

								<!-- Режим просмотра -->
								<Grid ColumnDefinitions="90,*"
                                      IsVisible="{Binding !IsEditingPassword}">
									<TextBlock Text="Пароль"
                                               Classes="FieldLabel"
                                               Opacity="0.7"/>
									<TextBlock Grid.Column="1"
                                               Text="••••••••••••"
                                               FontSize="14"
                                               Foreground="{DynamicResource TextSecondary}"
                                               LetterSpacing="2"/>
								</Grid>

								<!-- Режим редактирования -->
								<StackPanel Spacing="16" IsVisible="{Binding IsEditingPassword}">

									<!-- Текущий пароль -->
									<StackPanel Spacing="6">
										<TextBlock Text="Текущий пароль"
                                                   Classes="FieldLabel"
                                                   FontSize="12"/>
										<TextBox Text="{Binding CurrentPassword}"
                                                 Classes="DialogInput"
                                                 PasswordChar="•"
                                                 Watermark="Введите текущий пароль"
                                                 MaxWidth="320"
                                                 HorizontalAlignment="Left"/>
									</StackPanel>

									<Separator Background="{DynamicResource BorderDefault}"
                                               Margin="0,4"/>

									<!-- Новый пароль -->
									<Grid ColumnDefinitions="*,*" ColumnSpacing="12">
										<StackPanel Spacing="6">
											<TextBlock Text="Новый пароль"
                                                       Classes="FieldLabel"
                                                       FontSize="12"/>
											<TextBox Text="{Binding NewPassword}"
                                                     Classes="DialogInput"
                                                     PasswordChar="•"
                                                     Watermark="Минимум 6 символов"/>
											<TextBlock Text="{Binding NewPasswordValidationMessage}"
                                                       FontSize="11"
                                                       Foreground="{DynamicResource TextMuted}"
                                                       IsVisible="{Binding NewPasswordValidationMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
										</StackPanel>

										<StackPanel Grid.Column="1" Spacing="6">
											<TextBlock Text="Подтвердите пароль"
                                                       Classes="FieldLabel"
                                                       FontSize="12"/>
											<TextBox Text="{Binding ConfirmPassword}"
                                                     Classes="DialogInput"
                                                     PasswordChar="•"
                                                     Watermark="Повторите пароль"/>

											<!-- Индикатор совпадения -->
											<StackPanel Orientation="Horizontal"
                                                        Spacing="5"
                                                        Height="16"
                                                        IsVisible="{Binding ShowPasswordMatchIndicator}">

												<!-- Пароли совпадают -->
												<StackPanel Orientation="Horizontal"
                                                            Spacing="5"
                                                            IsVisible="{Binding PasswordsMatch}">
													<PathIcon Data="{StaticResource checkmark_regular}"
                                                              Width="12" Height="12"
                                                              Foreground="{DynamicResource SuccessBrush}"/>
													<TextBlock Text="Пароли совпадают"
                                                               FontSize="11"
                                                               Foreground="{DynamicResource SuccessBrush}"/>
												</StackPanel>

												<!-- Пароли не совпадают -->
												<StackPanel Orientation="Horizontal"
                                                            Spacing="5"
                                                            IsVisible="{Binding !PasswordsMatch}">
													<PathIcon Data="{StaticResource dismiss_regular}"
                                                              Width="12" Height="12"
                                                              Foreground="{DynamicResource ErrorBrush}"/>
													<TextBlock Text="Пароли не совпадают"
                                                               FontSize="11"
                                                               Foreground="{DynamicResource ErrorBrush}"/>
												</StackPanel>
											</StackPanel>
										</StackPanel>
									</Grid>

									<StackPanel Orientation="Horizontal" Spacing="10" Margin="0,4,0,0">
										<Button Content="Изменить пароль"
                                                Classes="DialogAccent"
                                                Command="{Binding SavePasswordCommand}"
                                                IsEnabled="{Binding CanSavePassword}"
                                                Padding="20,8"/>
										<Button Content="Отмена"
                                                Classes="DialogOutline"
                                                Command="{Binding CancelEditPasswordCommand}"
                                                Padding="16,8"/>
									</StackPanel>
								</StackPanel>
							</StackPanel>
						</Border>

						<!-- ═══════════════════════════════════════════════════════ -->
						<!-- ОТДЕЛ (если есть) -->
						<!-- ═══════════════════════════════════════════════════════ -->
						<Border Classes="ProfileSection"
                                IsVisible="{Binding User.Department, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
							<Grid ColumnDefinitions="Auto,*">
								<PathIcon Data="{StaticResource organization_regular}"
                                          Width="18" Height="18"
                                          Foreground="{DynamicResource Accent}"
                                          VerticalAlignment="Center"/>
								<StackPanel Grid.Column="1" Spacing="2" Margin="12,0,0,0">
									<TextBlock Text="Отдел"
                                               FontSize="12"
                                               Foreground="{DynamicResource TextSecondary}"/>
									<TextBlock Text="{Binding User.Department}"
                                               FontSize="14"
                                               FontWeight="Medium"/>
								</StackPanel>
							</Grid>
						</Border>

						<!-- ═══════════════════════════════════════════════════════ -->
						<!-- ВЫХОД -->
						<!-- ═══════════════════════════════════════════════════════ -->
						<Border Classes="ProfileSection">
							<Grid ColumnDefinitions="Auto,*,Auto">
								<PathIcon Data="{StaticResource SignOut}"
                                          Width="18" Height="18"
                                          Foreground="{DynamicResource DangerBrush}"
                                          VerticalAlignment="Center"/>
								<StackPanel Grid.Column="1"
                                            Spacing="2"
                                            VerticalAlignment="Center"
                                            Margin="12,0,0,0">
									<TextBlock Text="Выход из аккаунта"
                                               FontSize="14"
                                               FontWeight="Medium"/>
									<TextBlock Text="Вы будете перенаправлены на страницу входа"
                                               FontSize="12"
                                               Foreground="{DynamicResource TextMuted}"/>
								</StackPanel>
								<Button Grid.Column="2"
                                        Content="Выйти"
                                        Classes="DialogDanger"
                                        Command="{Binding LogoutCommand}"
                                        VerticalAlignment="Center"
                                        Padding="20,8"/>
							</Grid>
						</Border>

						<!-- ═══════════════════════════════════════════════════════ -->
						<!-- УВЕДОМЛЕНИЯ (АЛЕРТЫ) -->
						<!-- ═══════════════════════════════════════════════════════ -->

						<!-- Ошибка -->
						<Border Classes="AlertError"
                                IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
							<Grid ColumnDefinitions="Auto,*,Auto">
								<PathIcon Data="{StaticResource warning_regular}"
                                          Width="18" Height="18"
                                          Foreground="{DynamicResource ErrorBrush}"
                                          VerticalAlignment="Center"/>
								<TextBlock Grid.Column="1"
                                           Text="{Binding ErrorMessage}"
                                           Foreground="{DynamicResource ErrorBrush}"
                                           FontSize="13"
                                           TextWrapping="Wrap"
                                           Margin="10,0"/>
								<Button Grid.Column="2"
                                        Classes="IconButton Small"
                                        Command="{Binding ClearErrorCommand}"
                                        ToolTip.Tip="Закрыть">
									<PathIcon Data="{StaticResource close_regular}"
                                              Width="14" Height="14"
                                              Foreground="{DynamicResource ErrorBrush}"/>
								</Button>
							</Grid>
						</Border>

						<!-- Успех -->
						<Border Classes="AlertSuccess"
                                IsVisible="{Binding SuccessMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
							<Grid ColumnDefinitions="Auto,*,Auto">
								<PathIcon Data="{StaticResource checkmark_regular}"
                                          Width="18" Height="18"
                                          Foreground="{DynamicResource SuccessBrush}"
                                          VerticalAlignment="Center"/>
								<TextBlock Grid.Column="1"
                                           Text="{Binding SuccessMessage}"
                                           Foreground="{DynamicResource SuccessBrush}"
                                           FontSize="13"
                                           TextWrapping="Wrap"
                                           Margin="10,0"/>
								<Button Grid.Column="2"
                                        Classes="IconButton Small"
                                        Command="{Binding ClearSuccessCommand}"
                                        ToolTip.Tip="Закрыть">
									<PathIcon Data="{StaticResource close_regular}"
                                              Width="14" Height="14"
                                              Foreground="{DynamicResource SuccessBrush}"/>
								</Button>
							</Grid>
						</Border>

						<!-- Отступ снизу -->
						<Border Height="20"/>

					</StackPanel>
				</Grid>
			</Border>
		</ScrollViewer>
	</Border>
</UserControl>