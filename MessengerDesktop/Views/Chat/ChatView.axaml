<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="using:MessengerDesktop.Controls"
             xmlns:conv="using:MessengerDesktop.Converters"
             xmlns:chat="using:MessengerDesktop.Views.Chat"
             xmlns:managers="using:MessengerDesktop.ViewModels.Chat.Managers"
             xmlns:vmChat="clr-namespace:MessengerDesktop.ViewModels.Chat"
             x:Class="MessengerDesktop.Views.Chat.ChatView"
             x:DataType="vmChat:ChatViewModel"
             x:Name="Root"
             Design.Width="1280" Design.Height="720"
             Background="Transparent">

    <UserControl.Styles>
        <!-- â•â•â• ÐŸÐ¾Ð»Ðµ Ð²Ð²Ð¾Ð´Ð° â•â•â• -->
        <Style Selector="TextBox.ChatInput">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="8,12"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimary}"/>
            <Setter Property="AcceptsReturn" Value="True"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="MinHeight" Value="44"/>
            <Setter Property="MaxHeight" Value="400"/>
            <Setter Property="CaretBrush" Value="{DynamicResource TextPrimary}"/>
            <Setter Property="FocusAdorner" Value="{x:Null}"/>
        </Style>
        <Style Selector="TextBox.ChatInput /template/ Border,
                         TextBox.ChatInput:focus-within /template/ Border,
                         TextBox.ChatInput:pointerover /template/ Border">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>

        <!-- â•â•â• ÐŸÐ°Ð½ÐµÐ»ÑŒ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ / Ð¾Ñ‚Ð²ÐµÑ‚Ð° â•â•â• -->
        <Style Selector="Border.EditModePanel">
            <Setter Property="Background" Value="{DynamicResource PrimaryBG}"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="12,10"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
        </Style>

        <!-- â•â•â• ÐŸÑ€ÐµÐ²ÑŒÑŽ Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹ â•â•â• -->
        <Style Selector="Border.AttachmentPreview">
            <Setter Property="Background" Value="{DynamicResource PrimaryBG}"/>
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Padding" Value="10"/>
        </Style>

        <!-- â•â•â• Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ â•â•â• -->
        <Style Selector="ListBox.MessagesList">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style Selector="ListBox.MessagesList ListBoxItem">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0,1"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
        </Style>
        <Style Selector="ListBox.MessagesList ListBoxItem:selected /template/ ContentPresenter,
                         ListBox.MessagesList ListBoxItem:pointerover /template/ ContentPresenter,
                         ListBox.MessagesList ListBoxItem:selected:pointerover /template/ ContentPresenter,
                         ListBox.MessagesList ListBoxItem:selected:focus /template/ ContentPresenter">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
    </UserControl.Styles>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0"
                CornerRadius="16"
                Background="{DynamicResource SecondaryBG}">
            <Grid RowDefinitions="Auto,Auto,*,Auto">

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     Ð¨ÐÐŸÐšÐ Ð§ÐÐ¢Ð
                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <Border Grid.Row="0"
                        BorderBrush="{DynamicResource BorderDefault}"
                        BorderThickness="0,0,0,1"
                        Padding="16,0"
                        ZIndex="10">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                        <!-- ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‡Ð°Ñ‚Ð° -->
                        <TextBlock Grid.Column="0"
                                   Text="{Binding Chat.Name}"
                                   FontWeight="SemiBold"
                                   FontSize="18"
                                   VerticalAlignment="Center"/>

                        <!-- ÐšÐ½Ð¾Ð¿ÐºÐ¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ -->
                        <Border Grid.Column="2"
                                HorizontalAlignment="Right"
                                Background="{DynamicResource PrimaryBG}"
                                CornerRadius="4"
                                Margin="8">
                            <StackPanel Orientation="Horizontal">
                                <!-- ÐŸÐ¾Ð¸ÑÐº -->
                                <ToggleButton Classes="IconButton"
                                              ToolTip.Tip="ÐŸÐ¾Ð¸ÑÐº"
                                              CornerRadius="4,0,0,4"
                                              IsChecked="{Binding IsSearchMode}">
                                    <Path Data="{StaticResource SearchIcon}"
                                          Fill="{Binding Foreground,
                                              RelativeSource={RelativeSource AncestorType=ToggleButton}}"
                                          Width="20" Height="20"
                                          Stretch="Uniform"/>
                                </ToggleButton>

                                <!-- Ð˜Ð½Ñ„Ð¾-Ð¿Ð°Ð½ÐµÐ»ÑŒ -->
                                <ToggleButton Classes="IconButton"
                                              ToolTip.Tip="Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÐºÐ°Ð½Ð°Ð»Ðµ"
                                              CornerRadius="0"
                                              IsChecked="{Binding IsInfoPanelOpen}">
                                    <Path Data="{StaticResource PanelRight}"
                                          Fill="{Binding Foreground,
                                              RelativeSource={RelativeSource AncestorType=ToggleButton}}"
                                          Width="20" Height="20"
                                          Stretch="Uniform"/>
                                </ToggleButton>

                                <!-- ÐœÐµÐ½ÑŽ -->
                                <Button Classes="IconButton"
                                        ToolTip.Tip="ÐœÐµÐ½ÑŽ"
                                        CornerRadius="0,4,4,0">
                                    <Button.Flyout>
                                        <MenuFlyout Placement="BottomEdgeAlignedRight">
                                            <MenuItem Header="Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¾Ð¿Ñ€Ð¾Ñ"
                                                      Command="{Binding OpenCreatePollCommand}">
                                                <MenuItem.IsVisible>
                                                    <MultiBinding Converter="{conv:MultiConverter Name=BooleanAnd}">
                                                        <Binding Path="IsGroupChat"/>
                                                        <Binding Path=""
                                                                 Converter="{conv:Converter Name=HasRole}"
                                                                 ConverterParameter="Admin"/>
                                                    </MultiBinding>
                                                </MenuItem.IsVisible>
                                            </MenuItem>
                                            <MenuItem Header="Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ñ‡Ð°Ñ‚Ð°"
                                                      Command="{Binding LeaveChatCommand}"
                                                      Foreground="{DynamicResource DangerBrush}"/>
                                        </MenuFlyout>
                                    </Button.Flyout>
                                    <Path Margin="10,0,0,0"
                                          Data="{StaticResource Options}"
                                          Width="20" Height="20"
                                          Fill="{DynamicResource TextPrimary}"
                                          Stretch="Uniform"/>
                                </Button>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Border>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     Ð”Ð•ÐšÐžÐ ÐÐ¢Ð˜Ð’ÐÐ«Ð™ Ð¤ÐžÐ
                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <Panel Grid.Row="2" Grid.RowSpan="2">
                    <Border Opacity="0.4">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                                <GradientStop Color="{DynamicResource TopBg}" Offset="0"/>
                                <GradientStop Color="{DynamicResource BaseBg}" Offset="1"/>
                            </LinearGradientBrush>
                        </Border.Background>
                    </Border>
                    <Canvas IsHitTestVisible="False" Opacity="0.03">
                        <Ellipse Width="60" Height="60" Fill="{DynamicResource TextPrimary}"
                                 Canvas.Left="50" Canvas.Top="100"/>
                        <Ellipse Width="40" Height="40" Fill="{DynamicResource TextPrimary}"
                                 Canvas.Left="200" Canvas.Top="50"/>
                        <Ellipse Width="30" Height="30" Fill="{DynamicResource TextPrimary}"
                                 Canvas.Left="350" Canvas.Top="180"/>
                        <Ellipse Width="50" Height="50" Fill="{DynamicResource TextPrimary}"
                                 Canvas.Left="500" Canvas.Top="80"/>
                        <Ellipse Width="35" Height="35" Fill="{DynamicResource TextPrimary}"
                                 Canvas.Left="150" Canvas.Top="300"/>
                        <Ellipse Width="45" Height="45" Fill="{DynamicResource TextPrimary}"
                                 Canvas.Left="400" Canvas.Top="350"/>
                        <Ellipse Width="25" Height="25" Fill="{DynamicResource TextPrimary}"
                                 Canvas.Left="600" Canvas.Top="200"/>
                        <Ellipse Width="55" Height="55" Fill="{DynamicResource TextPrimary}"
                                 Canvas.Left="700" Canvas.Top="400"/>
                    </Canvas>
                </Panel>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     ÐžÐ‘Ð›ÐÐ¡Ð¢Ð¬ Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð™
                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <Panel Grid.Row="2">
                    <!-- Skeleton-Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° -->
                    <controls:ChatMessagesSkeleton IsVisible="{Binding IsInitialLoading}"/>

                    <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ -->
                    <ListBox x:Name="MessagesList"
                             Classes="MessagesList"
                             ItemsSource="{Binding Messages}"
                             Margin="0,8"
                             Padding="16,0"
                             IsVisible="{Binding !IsInitialLoading}"
                             ScrollViewer.VerticalScrollBarVisibility="Auto"
                             SelectionMode="Single,Toggle">
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel/>
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.ItemTemplate>
                            <DataTemplate x:DataType="vmChat:MessageViewModel">
                                <chat:MessageControl
                                    EditMessageCommand="{Binding $parent[UserControl].((vmChat:ChatViewModel)DataContext).StartEditMessageCommand}"
                                    CopyTextCommand="{Binding $parent[UserControl].((vmChat:ChatViewModel)DataContext).CopyMessageTextCommand}"
                                    DeleteMessageCommand="{Binding $parent[UserControl].((vmChat:ChatViewModel)DataContext).DeleteMessageCommand}"
                                    OpenProfileCommand="{Binding $parent[UserControl].((vmChat:ChatViewModel)DataContext).OpenProfileCommand}"
                                    ReplyCommand="{Binding $parent[UserControl].((vmChat:ChatViewModel)DataContext).StartReplyCommand}"
                                    ScrollToReplyCommand="{Binding $parent[UserControl].((vmChat:ChatViewModel)DataContext).ScrollToReplyOriginalCommand}"
                                    RetryTranscriptionCommand="{Binding $parent[UserControl].((vmChat:ChatViewModel)DataContext).RetryTranscriptionCommand}"/>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Â«Ð²Ð½Ð¸Ð·Â» -->
                    <Button Classes="ScrollToBottomButton"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Bottom"
                            Margin="0,0,24,16"
                            IsVisible="{Binding ShowScrollToBottom}"
                            Command="{Binding ScrollToBottomCommand}">
                        <Panel>
                            <Path Data="{StaticResource ChevronIcon}"
                                  Fill="{DynamicResource TextPrimary}"
                                  Width="18" Height="18"
                                  Stretch="Uniform"
                                  HorizontalAlignment="Center"
                                  Margin="0,25"/>

                            <!-- Ð‘ÐµÐ¹Ð´Ð¶ Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ… -->
                            <Border Background="{DynamicResource Accent}"
                                    CornerRadius="10"
                                    MinWidth="20" Height="20"
                                    Padding="6,0"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Top"
                                    Margin="0,0,-10,0"
                                    IsVisible="{Binding HasNewMessages}">
                                <TextBlock Text="{Binding UnreadCount, FallbackValue=!}"
                                           FontSize="11"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextOnAccent}"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"/>
                            </Border>
                        </Panel>
                    </Button>
                </Panel>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     ÐŸÐÐÐ•Ð›Ð¬ Ð’Ð’ÐžÐ”Ð
                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <Border Grid.Row="3" VerticalAlignment="Bottom" Padding="16,0,16,20">
                    <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto">

                        <!-- Row 0: ÐŸÐ°Ð½ÐµÐ»ÑŒ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ -->
                        <Border Grid.Row="0"
                                Classes="EditModePanel"
                                IsVisible="{Binding IsEditMode}">
                            <Grid ColumnDefinitions="Auto,*,Auto">
                                <Border Grid.Column="0"
                                        Width="4"
                                        Background="{DynamicResource Accent}"
                                        CornerRadius="2"
                                        Margin="0,0,12,0"/>
                                <StackPanel Grid.Column="1" Spacing="2">
                                    <TextBlock Text="Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ"
                                               FontWeight="SemiBold" FontSize="12"
                                               Foreground="{DynamicResource Accent}"/>
                                    <ContentControl Content="{Binding EditingMessage}"
                                                    Padding="0" MinHeight="0" BorderThickness="0">
                                        <ContentControl.ContentTemplate>
                                            <DataTemplate x:DataType="vmChat:MessageViewModel">
                                                <TextBlock Text="{Binding Content}"
                                                           FontSize="13"
                                                           Foreground="{DynamicResource TextSecondary}"
                                                           TextTrimming="CharacterEllipsis"
                                                           MaxLines="2"/>
                                            </DataTemplate>
                                        </ContentControl.ContentTemplate>
                                    </ContentControl>
                                </StackPanel>
                                <Button Grid.Column="2"
                                        Classes="IconButton Small"
                                        Command="{Binding CancelEditMessageCommand}"
                                        ToolTip.Tip="ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ">
                                    <TextBlock Text="âœ•" FontSize="14"
                                               Foreground="{DynamicResource TextSecondary}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>
                                </Button>
                            </Grid>
                        </Border>

                        <!-- Row 1: ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚Ð° -->
                        <Border Grid.Row="1"
                                Classes="EditModePanel"
                                IsVisible="{Binding IsReplyMode}">
                            <Grid ColumnDefinitions="Auto,*,Auto">
                                <Border Grid.Column="0"
                                        Width="4"
                                        Background="{DynamicResource Accent}"
                                        CornerRadius="2"
                                        Margin="0,0,12,0"/>
                                <ContentControl Grid.Column="1"
                                                Content="{Binding ReplyingToMessage}"
                                                Padding="0" MinHeight="0" BorderThickness="0">
                                    <ContentControl.ContentTemplate>
                                        <DataTemplate x:DataType="vmChat:MessageViewModel">
                                            <StackPanel Spacing="2">
                                                <TextBlock Text="{Binding SenderName,
                                                               StringFormat='ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð»Ñ {0}'}"
                                                           FontWeight="SemiBold" FontSize="12"
                                                           Foreground="{DynamicResource Accent}"/>
                                                <TextBlock Text="{Binding Content}"
                                                           FontSize="13"
                                                           Foreground="{DynamicResource TextSecondary}"
                                                           TextTrimming="CharacterEllipsis"
                                                           MaxLines="2"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ContentControl.ContentTemplate>
                                </ContentControl>
                                <Button Grid.Column="2"
                                        Classes="IconButton Small"
                                        Command="{Binding CancelReplyCommand}"
                                        ToolTip.Tip="ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚">
                                    <TextBlock Text="âœ•" FontSize="14"
                                               Foreground="{DynamicResource TextSecondary}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>
                                </Button>
                            </Grid>
                        </Border>

                        <!-- Row 2: Ð’Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ -->
                        <ItemsControl Grid.Row="2"
                                      ItemsSource="{Binding LocalAttachments}"
                                      Margin="0,0,0,8"
                                      IsVisible="{Binding LocalAttachments.Count}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Spacing="6"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="managers:LocalFileAttachment">
                                    <Border Classes="AttachmentPreview">
                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                            <Border Grid.Column="0"
                                                    Width="44" Height="44"
                                                    CornerRadius="8"
                                                    ClipToBounds="True"
                                                    Background="{DynamicResource SecondaryBG}">
                                                <Panel>
                                                    <TextBlock Text="ðŸ“Ž"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"
                                                               IsVisible="{Binding Thumbnail,
                                                                   Converter={x:Static ObjectConverters.IsNull}}"/>
                                                    <Image Source="{Binding Thumbnail}"
                                                           IsVisible="{Binding Thumbnail,
                                                               Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                                </Panel>
                                            </Border>
                                            <StackPanel Grid.Column="1"
                                                        Margin="12,0"
                                                        VerticalAlignment="Center">
                                                <TextBlock Text="{Binding FileName}"
                                                           FontWeight="Medium" FontSize="13"
                                                           TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Text="{Binding FileSizeFormatted}"
                                                           FontSize="11"
                                                           Foreground="{DynamicResource TextSecondary}"/>
                                            </StackPanel>
                                            <Button Grid.Column="2"
                                                    Classes="IconButton Small"
                                                    ToolTip.Tip="Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ"
                                                    Command="{Binding $parent[UserControl].((vmChat:ChatViewModel)DataContext).RemoveAttachmentCommand}"
                                                    CommandParameter="{Binding}">
                                                <TextBlock Text="âœ•" FontSize="14"
                                                           Foreground="{DynamicResource TextSecondary}"/>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Row 3: ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð³Ð¾Ð»Ð¾ÑÐ° -->
                        <Border Grid.Row="3"
                                Background="{DynamicResource PrimaryBG}"
                                CornerRadius="12"
                                Padding="12,10"
                                Margin="0,0,0,8"
                                IsVisible="{Binding IsVoiceRecording}">
                            <Grid ColumnDefinitions="Auto,Auto,*,Auto">
                                <!-- ÐœÐ¸Ð³Ð°ÑŽÑ‰Ð¸Ð¹ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð·Ð°Ð¿Ð¸ÑÐ¸ -->
                                <Ellipse Grid.Column="0"
                                         Width="12" Height="12"
                                         Fill="#FF4444"
                                         Margin="0,0,10,0"
                                         VerticalAlignment="Center">
                                    <Ellipse.Styles>
                                        <Style Selector="Ellipse">
                                            <Style.Animations>
                                                <Animation Duration="0:0:1"
                                                           IterationCount="INFINITE">
                                                    <KeyFrame Cue="0%">
                                                        <Setter Property="Opacity" Value="1"/>
                                                    </KeyFrame>
                                                    <KeyFrame Cue="50%">
                                                        <Setter Property="Opacity" Value="0.3"/>
                                                    </KeyFrame>
                                                    <KeyFrame Cue="100%">
                                                        <Setter Property="Opacity" Value="1"/>
                                                    </KeyFrame>
                                                </Animation>
                                            </Style.Animations>
                                        </Style>
                                    </Ellipse.Styles>
                                </Ellipse>

                                <!-- Ð¢Ð°Ð¹Ð¼ÐµÑ€ Ð·Ð°Ð¿Ð¸ÑÐ¸ -->
                                <ContentControl Grid.Column="1"
                                                Content="{Binding VoiceRecording}"
                                                Padding="0" MinHeight="0" BorderThickness="0"
                                                Margin="0,0,12,0"
                                                VerticalContentAlignment="Center">
                                    <ContentControl.ContentTemplate>
                                        <DataTemplate x:DataType="vmChat:VoiceRecordingViewModel">
                                            <TextBlock Text="{Binding ElapsedFormatted}"
                                                       FontSize="16" FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextPrimary}"
                                                       VerticalAlignment="Center"/>
                                        </DataTemplate>
                                    </ContentControl.ContentTemplate>
                                </ContentControl>

                                <TextBlock Grid.Column="2"
                                           Text="Ð—Ð°Ð¿Ð¸ÑÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ..."
                                           FontSize="13"
                                           Foreground="{DynamicResource TextSecondary}"
                                           VerticalAlignment="Center"/>

                                <!-- ÐžÑ‚Ð¼ÐµÐ½Ð° Ð·Ð°Ð¿Ð¸ÑÐ¸ -->
                                <Button Grid.Column="3"
                                        Classes="IconButton Small"
                                        Command="{Binding CancelVoiceRecordingCommand}"
                                        ToolTip.Tip="ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ">
                                    <TextBlock Text="âœ•" FontSize="16"
                                               Foreground="{DynamicResource DangerBrush}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>
                                </Button>
                            </Grid>
                        </Border>

                        <!-- Ð˜Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð³Ð¾Ð»Ð¾ÑÐ° -->
                        <Border Grid.Row="3"
                                Background="{DynamicResource PrimaryBG}"
                                CornerRadius="12"
                                Padding="12,10"
                                Margin="0,0,0,8"
                                IsVisible="{Binding IsVoiceSending}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="ðŸ“¤" FontSize="16" VerticalAlignment="Center"/>
                                <TextBlock Text="ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ..."
                                           FontSize="13"
                                           Foreground="{DynamicResource TextSecondary}"
                                           VerticalAlignment="Center"/>
                                <Button Classes="IconButton Small"
                                        Command="{Binding CancelVoiceRecordingCommand}"
                                        ToolTip.Tip="ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ">
                                    <TextBlock Text="âœ•" FontSize="14"
                                               Foreground="{DynamicResource DangerBrush}"/>
                                </Button>
                            </StackPanel>
                        </Border>

                        <!-- ÐžÑˆÐ¸Ð±ÐºÐ° Ð³Ð¾Ð»Ð¾ÑÐ° -->
                        <Border Grid.Row="3"
                                Background="#33FF4444"
                                CornerRadius="10"
                                Padding="10,8"
                                Margin="0,0,0,8"
                                IsVisible="{Binding VoiceError,
                                    Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                            <TextBlock Text="{Binding VoiceError}"
                                       FontSize="12"
                                       Foreground="{DynamicResource DangerBrush}"
                                       TextWrapping="Wrap"/>
                        </Border>

                        <!-- Row 4: ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ð²Ð²Ð¾Ð´Ð° -->
                        <Border Grid.Row="4"
                                Background="{DynamicResource PrimaryBG}"
                                CornerRadius="14"
                                IsVisible="{Binding !IsVoiceRecording}">
                            <Grid Margin="4" ColumnDefinitions="Auto,*,Auto,Auto,Auto">
                                <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹ -->
                                <Button Grid.Column="0"
                                        Classes="IconButton"
                                        ToolTip.Tip="ÐŸÑ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»"
                                        Width="44" Height="44"
                                        CornerRadius="10"
                                        Command="{Binding AttachFileCommand}"
                                        IsVisible="{Binding !IsEditMode}">
                                    <Path Data="{StaticResource AttachIcon}"
                                          Fill="{DynamicResource TextSecondary}"
                                          Width="20" Height="20"
                                          Stretch="Uniform"/>
                                </Button>

                                <!-- ÐŸÐ¾Ð»Ðµ Ð²Ð²Ð¾Ð´Ð° (Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼) -->
                                <TextBox Grid.Column="1"
                                         Classes="ChatInput"
                                         Text="{Binding NewMessage, Mode=TwoWay}"
                                         Watermark="Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..."
                                         IsVisible="{Binding !IsEditMode}"/>

                                <!-- ÐŸÐ¾Ð»Ðµ Ð²Ð²Ð¾Ð´Ð° (Ñ€ÐµÐ¶Ð¸Ð¼ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ) -->
                                <TextBox Grid.Column="1"
                                         Classes="ChatInput"
                                         Text="{Binding EditMessageContent, Mode=TwoWay}"
                                         Watermark="Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ..."
                                         IsVisible="{Binding IsEditMode}"/>

                                <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° ÑÐ¼Ð¾Ð´Ð·Ð¸ -->
                                <Button Grid.Column="2"
                                        Classes="IconButton"
                                        ToolTip.Tip="Ð­Ð¼Ð¾Ð´Ð·Ð¸"
                                        Width="44" Height="44"
                                        CornerRadius="10"
                                        VerticalAlignment="Bottom">
                                    <Button.Flyout>
                                        <Flyout Placement="TopEdgeAlignedRight"
                                                ShowMode="TransientWithDismissOnPointerMoveAway">
                                            <StackPanel Spacing="8">
                                                <TextBlock Text="Ð­Ð¼Ð¾Ð´Ð·Ð¸"
                                                           Classes="SectionHeader"
                                                           Margin="4,0,0,4"/>
                                                <ItemsControl ItemsSource="{Binding PopularEmojis}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <WrapPanel MaxWidth="320"
                                                                       Orientation="Horizontal"/>
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Button Classes="EmojiButton"
                                                                    Content="{Binding}"
                                                                    Command="{Binding $parent[UserControl].((vmChat:ChatViewModel)DataContext).InsertEmojiCommand}"
                                                                    CommandParameter="{Binding}"/>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </StackPanel>
                                        </Flyout>
                                    </Button.Flyout>
                                    <Path Data="{StaticResource EmojiIcon}"
                                          Fill="{DynamicResource TextSecondary}"
                                          Width="20" Height="20"
                                          Stretch="Uniform"/>
                                </Button>

                                <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð³Ð¾Ð»Ð¾ÑÐ° -->
                                <Button Grid.Column="3"
                                        Classes="IconButton"
                                        ToolTip.Tip="Ð—Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"
                                        Width="44" Height="44"
                                        CornerRadius="10"
                                        VerticalAlignment="Bottom"
                                        Command="{Binding StartVoiceRecordingCommand}"
                                        IsVisible="{Binding IsVoiceSupported}">
                                    <TextBlock Text="ðŸŽ¤" FontSize="20"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>
                                </Button>

                                <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ / ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ -->
                                <Button Grid.Column="4"
                                        Classes="Primary"
                                        Margin="4"
                                        Width="36" Height="36"
                                        CornerRadius="10"
                                        Padding="0"
                                        Command="{Binding SendMessageCommand}"
                                        VerticalAlignment="Bottom"
                                        ToolTip.Tip="{Binding IsEditMode,
                                            Converter={conv:Converter Name=BoolToString},
                                            ConverterParameter='Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ|ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ'}">
                                    <Panel>
                                        <Path Data="{StaticResource SendIcon}"
                                              Fill="White" Width="18" Height="18"
                                              Stretch="Uniform"
                                              IsVisible="{Binding !IsEditMode}"/>
                                        <Path Data="{StaticResource CheckmarkIcon}"
                                              Fill="White" Width="18" Height="18"
                                              Stretch="Uniform"
                                              IsVisible="{Binding IsEditMode}"/>
                                    </Panel>
                                </Button>
                            </Grid>
                        </Border>

                        <!-- ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð²Ð²Ð¾Ð´Ð° Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ -->
                        <Border Grid.Row="4"
                                Background="{DynamicResource PrimaryBG}"
                                CornerRadius="14"
                                IsVisible="{Binding IsVoiceRecording}">
                            <Grid Margin="4" ColumnDefinitions="*,Auto">
                                <TextBlock Grid.Column="0"
                                           Text="ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ â†’"
                                           FontSize="14"
                                           Foreground="{DynamicResource TextSecondary}"
                                           VerticalAlignment="Center"
                                           Margin="12,0"/>
                                <Button Grid.Column="1"
                                        Classes="Primary"
                                        Margin="4"
                                        Width="44" Height="44"
                                        CornerRadius="10"
                                        Padding="0"
                                        Command="{Binding StopAndSendVoiceCommand}"
                                        ToolTip.Tip="ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ">
                                    <Path Data="{StaticResource SendIcon}"
                                          Fill="White" Width="20" Height="20"
                                          Stretch="Uniform"/>
                                </Button>
                            </Grid>
                        </Border>

                    </Grid>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>